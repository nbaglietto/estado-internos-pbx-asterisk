name: CI/CD Sistema Internos

on:
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    branches:
      - main
      - staging

env:
  PHP_VERSION: '8.1'

jobs:
  test:
    name: ğŸ§ª Tests y ValidaciÃ³n
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json
          tools: composer:v2

      - name: ğŸ“¦ Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: ğŸ”§ Install dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --prefer-dist --no-progress --no-scripts
          else
            echo "No composer.json found, skipping composer install"
          fi

      - name: âœ… PHP Syntax Check
        run: |
          echo "ğŸ” Checking PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | grep -v "No syntax errors"
          echo "âœ… PHP syntax check passed"

      - name: ğŸ§¹ Code Quality Check
        run: |
          echo "ğŸ” Checking for common issues..."
          # Verificar que no haya credenciales hardcodeadas
          if grep -r "password\|secret\|key" --include="*.php" . | grep -v "placeholder\|example\|ENV\|config.php"; then
            echo "âŒ Possible hardcoded credentials found"
            exit 1
          fi
          echo "âœ… Code quality check passed"

      - name: ğŸ”’ Security Check
        run: |
          echo "ğŸ” Checking for security issues..."
          # Verificar que .env no estÃ© en el repositorio
          if [ -f .env ]; then
            echo "âŒ .env file found in repository"
            exit 1
          fi
          echo "âœ… Security check passed"

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment: staging
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting staging deployment..."
            cd /var/www/html/staging-internos || exit 1
            sudo cp -r . ../backup-staging-$(date +%Y%m%d-%H%M%S)
            git fetch origin
            git reset --hard origin/staging
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader
            fi
            sudo chown -R www-data:www-data .
            sudo chmod -R 755 .
            echo "âœ… Staging deployment completed successfully"

  deploy-production:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting production deployment..."
            cd /var/www/html/internos || exit 1
            sudo cp -r . ../backup-prod-$(date +%Y%m%d-%H%M%S)
            git fetch origin
            git reset --hard origin/main
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader
            fi
            [ -d cache ] && rm -rf cache/*
            [ -d logs/*.log ] && > logs/*.log
            sudo chown -R www-data:www-data .
            sudo chmod -R 755 .
            echo "âœ… Production deployment completed successfully"

  notify:
    name: ğŸ“± Notificaciones
    needs: [test, deploy-staging, deploy-production]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "Tests: ${{ needs.test.result }}"
          echo "Staging: ${{ needs.deploy-staging.result }}"
          echo "Production: ${{ needs.deploy-production.result }}"
          if [ "${{ needs.test.result }}" = "failure" ]; then
            echo "âŒ Tests failed - deployment blocked"
          elif [ "${{ needs.deploy-production.result }}" = "success" ]; then
            echo "âœ… Production deployment successful"
          elif [ "${{ needs.deploy-staging.result }}" = "success" ]; then
            echo "âœ… Staging deployment successful"
